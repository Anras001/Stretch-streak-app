<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stretch Streak Tracker</title>
<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 680px; margin: auto; padding: 20px; background: #0b1020; color: #e6eef8; }
h1 { margin-top: 0; }
input, select { width: 100%; padding: 12px 14px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #223157; background: #0f152d; color: #e6eef8; }
button { padding: 10px 14px; border: 0; border-radius: 12px; cursor: pointer; margin-right: 8px; font-weight: 700; }
.primary { background: #10b981; color: #052b1f; }
.ghost { background: transparent; border: 1px solid #223157; color: #e6eef8; }
.tag { display: inline-block; background: #101933; border: 1px solid #223157; padding: 6px 10px; border-radius: 999px; font-size: 12px; margin-left: 6px; color: #9aa3b2; }
.day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 12px; }
.day { padding: 8px 0; text-align: center; border-radius: 8px; background: #0f162f; border: 1px solid #203056; color: #9aa3b2; font-size: 12px; }
.day.ok { background: #0f3a2a; color: #c9ffe6; border-color: #18543c; }
.small { font-size: 12px; color: #9aa3b2; }
details { margin-top: 6px; }
</style>
</head>
<body>
<h1>Stretch Streak Tracker</h1>

<label>Dein Name</label>
<select id="player">
  <option>Anu</option>
  <option>Dominik</option>
</select>

<label>Raum-Code (gemeinsam verwenden)</label>
<input id="room" placeholder="anu-dominik-stretch">

<details>
  <summary>GitHub Repo & Token einstellen</summary>
  <label>Owner</label>
  <input id="ghOwner" value="Anras001">
  <label>Repo</label>
  <input id="ghRepo" value="Stretch-streak">
  <label>Branch</label>
  <input id="ghBranch" value="main">
  <label>Datei</label>
  <input id="ghPath" value="data.json">
  <label>Token (nur lokal gespeichert)</label>
  <input id="ghToken" placeholder="ghp_..." type="password">
  <button id="saveCfg" class="ghost">Speichern</button>
  <p class="small">Hinweis: Der Token wird nur lokal im Browser gespeichert (localStorage). Teile ihn nur privat.</p>
</details>

<div style="margin:10px 0;">
  <button id="btnDone" class="primary">Ich hab's geschafft ✅</button>
  <button id="btnUndo" class="ghost">Zurücknehmen</button>
  <span id="status" class="tag">Offline</span>
</div>

<div id="calendar" class="day-grid"></div>

<script>
const $ = id => document.getElementById(id);
const TZ = 'Europe/Berlin';
const state = {
  player: localStorage.getItem('player') || 'Anu',
  room: new URLSearchParams(location.search).get('room') || localStorage.getItem('room') || 'anu-dominik-stretch',
  today: new Date().toLocaleDateString('en-CA', { timeZone: TZ }),
  owner: localStorage.getItem('ghOwner') || 'Anras001',
  repo: localStorage.getItem('ghRepo') || 'Stretch-streak',
  branch: localStorage.getItem('ghBranch') || 'main',
  path: localStorage.getItem('ghPath') || 'data.json',
  token: localStorage.getItem('ghToken') || '',
  cache: {}, sha: null
};
$('player').value = state.player; $('room').value = state.room;
$('ghOwner').value = state.owner; $('ghRepo').value = state.repo; $('ghBranch').value = state.branch; $('ghPath').value = state.path; $('ghToken').value = state.token;

function daysBack(n){ const d=new Date(); d.setDate(d.getDate()-n); return d.toLocaleDateString('en-CA',{timeZone:TZ}); }
function encodeBase64(s){return btoa(unescape(encodeURIComponent(s)));}
function decodeBase64(s){return decodeURIComponent(escape(atob(s)));}

async function ghHeaders(){
  const h={'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'};
  if(state.token) h['Authorization']='Bearer '+state.token;
  return h;
}

// Aktuellste data.json + sha holen
async function loadLatest(){
  const url = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path}?ref=${encodeURIComponent(state.branch)}`;
  const res = await fetch(url, { headers: await ghHeaders() });
  if(res.status===404) return { cache:{}, sha:null };
  const json = await res.json();
  const cache = JSON.parse(decodeBase64(json.content) || "{}");
  return { cache, sha: json.sha };
}

// Speichern mit gegebener sha
async function putData(cache, sha){
  const url = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path}`;
  const body = { message: 'update streak', content: encodeBase64(JSON.stringify(cache,null,2)), branch: state.branch };
  if(sha) body.sha = sha;
  return fetch(url, { method:'PUT', headers:{...(await ghHeaders()),'Content-Type':'application/json'}, body: JSON.stringify(body) });
}

// Seite laden (für Anzeige)
async function loadData(){
  const { cache, sha } = await loadLatest();
  state.cache = cache; state.sha = sha;
  render();
  $('status').textContent = 'Bereit';
}

// Klick/Undo – konfliktfest (bis zu 3 Versuche mit Merge)
async function tick(val){
  if(!state.token){ alert('Bitte Token eintragen'); return; }
  const me = state.player.toLowerCase();         // "anu" oder "dominik"
  const room = state.room.trim() || 'anu-dominik-stretch';
  const today = state.today;

  for(let attempt=0; attempt<3; attempt++){
    // 1) Neu laden (immer von GitHub)
    const { cache, sha } = await loadLatest();

    // 2) Änderung mergen
    if(!cache[room]) cache[room] = {};
    const rec = cache[room][today] || { anu:false, dominik:false };
    rec[me] = val;                                // setzen oder zurücknehmen
    cache[room][today] = rec;

    // 3) Speichern
    const res = await putData(cache, sha);
    if(res.ok){
      // Lokal aktualisieren & UI updaten
      const jr = await res.json();
      state.cache = cache; state.sha = jr.content.sha;
      render();
      $('status').textContent = 'Gespeichert';
      return;
    }
    if(res.status !== 409){
      const t = await res.text();
      alert('Fehler beim Speichern: ' + t);
      return;
    }
    // kleine Wartezeit vor erneutem Versuch
    await new Promise(r=>setTimeout(r, 400));
  }
  alert('Konflikt beim Speichern – bitte Seite kurz neu laden und nochmal versuchen.');
}

function render(){
  if(!state.room) return;
  if(!state.cache[state.room]) state.cache[state.room]={};
  const cal=$('calendar'); cal.innerHTML='';
  for(let i=41;i>=0;i--){
    const id=daysBack(i);
    const cell=document.createElement('div'); cell.className='day';
    cell.textContent = new Date(id).getDate();
    const me=state.player.toLowerCase();
    const rec = state.cache[state.room][id] || {};
    if(rec[me]) cell.classList.add('ok');
    cal.appendChild(cell);
  }
}

$('saveCfg').onclick=()=>{
  state.player=$('player').value; state.room=($('room').value||'').trim()||'anu-dominik-stretch';
  state.owner=$('ghOwner').value; state.repo=$('ghRepo').value;
  state.branch=$('ghBranch').value; state.path=$('ghPath').value;
  state.token=$('ghToken').value;
  localStorage.setItem('player', state.player);
  localStorage.setItem('room', state.room);
  localStorage.setItem('ghOwner', state.owner);
  localStorage.setItem('ghRepo', state.repo);
  localStorage.setItem('ghBranch', state.branch);
  localStorage.setItem('ghPath', state.path);
  localStorage.setItem('ghToken', state.token);
  loadData();
};

$('btnDone').onclick=()=>tick(true);
$('btnUndo').onclick=()=>tick(false);

loadData();
</script>
</body>
</html>
