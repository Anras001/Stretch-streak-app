
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stretch Streak Tracker</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1rem; background: #0b1020; color: #fff; }
input, select { width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid #444; background: #111; color: #fff; }
button { padding: 0.5rem 1rem; border: none; border-radius: 8px; margin: 0.25rem 0; cursor: pointer; }
.primary { background: #10b981; color: #000; }
.ghost { background: transparent; border: 1px solid #444; color: #fff; }
.tag { display: inline-block; background: #222; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.8rem; margin-left: 0.5rem; }
.day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 1rem; }
.day { padding: 0.25rem; text-align: center; border-radius: 6px; background: #222; font-size: 0.8rem; }
.day.ok { background: #065f46; color: #bfffd9; }
</style>
</head>
<body>
<h1>Stretch Streak Tracker</h1>
<p>Ein Klick pro Tag – synchron mit eurem privaten Repo (Token nötig zum Speichern).</p>

<label>Dein Name</label>
<select id="player">
  <option>Anu</option>
  <option>Domik</option>
</select>

<label>Raum-Code (gemeinsam verwenden)</label>
<input id="room" placeholder="anu-domik-stretch">

<details>
  <summary>GitHub Repo & Token einstellen</summary>
  <label>Owner</label>
  <input id="ghOwner" value="Anras001">
  <label>Repo</label>
  <input id="ghRepo" value="Stretch-streak">
  <label>Branch</label>
  <input id="ghBranch" value="main">
  <label>Datei</label>
  <input id="ghPath" value="data.json">
  <label>Token (nur lokal gespeichert)</label>
  <input id="ghToken" placeholder="ghp_..." type="password">
  <button id="saveCfg" class="ghost">Speichern</button>
</details>

<button id="btnDone" class="primary">Ich hab's geschafft ✅</button>
<button id="btnUndo" class="ghost">Zurücknehmen</button>
<span id="status" class="tag">Offline</span>

<div id="calendar" class="day-grid"></div>

<script>
const $ = id => document.getElementById(id);
const TZ = 'Europe/Berlin';
const state = {
  player: localStorage.getItem('player') || 'Anu',
  room: new URLSearchParams(location.search).get('room') || localStorage.getItem('room') || 'anu-domik-stretch',
  today: new Date().toLocaleDateString('en-CA', { timeZone: TZ }),
  owner: localStorage.getItem('ghOwner') || 'Anras001',
  repo: localStorage.getItem('ghRepo') || 'Stretch-streak',
  branch: localStorage.getItem('ghBranch') || 'main',
  path: localStorage.getItem('ghPath') || 'data.json',
  token: localStorage.getItem('ghToken') || '',
  cache: {}, sha: null
};
$('player').value = state.player; $('room').value = state.room;
$('ghOwner').value = state.owner; $('ghRepo').value = state.repo; $('ghBranch').value = state.branch; $('ghPath').value = state.path; $('ghToken').value = state.token;

function daysBack(n){ const d=new Date(); d.setDate(d.getDate()-n); return d.toLocaleDateString('en-CA',{timeZone:TZ}); }
function encodeBase64(s){return btoa(unescape(encodeURIComponent(s)));}
function decodeBase64(s){return decodeURIComponent(escape(atob(s)));}
async function ghHeaders(){ const h={'Accept':'application/vnd.github+json'}; if(state.token) h['Authorization']='Bearer '+state.token; return h; }
function ensureRoom(){ if(!state.cache[state.room]) state.cache[state.room] = {}; }

async function loadData(){
  const url = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path}?ref=${encodeURIComponent(state.branch)}`;
  const res = await fetch(url, {headers: await ghHeaders()});
  if(res.status===404){ state.cache={}; state.sha=null; render(); return; }
  const json=await res.json();
  state.sha=json.sha;
  state.cache = JSON.parse(decodeBase64(json.content)||"{}");
  render();
}

async function saveData(){
  const url = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path}`;
  const body = { message: 'update streak', content: encodeBase64(JSON.stringify(state.cache,null,2)), branch: state.branch };
  if(state.sha) body.sha=state.sha;
  await fetch(url,{method:'PUT', headers:{...(await ghHeaders()),'Content-Type':'application/json'}, body: JSON.stringify(body)});
}

function render(){
  ensureRoom();
  const cal=$('calendar'); cal.innerHTML='';
  for(let i=41;i>=0;i--){
    const id=daysBack(i);
    const cell=document.createElement('div'); cell.className='day';
    cell.textContent = new Date(id).getDate();
    const me=state.player.toLowerCase();
    if(state.cache[state.room]?.[id]?.[me]) cell.classList.add('ok');
    cal.appendChild(cell);
  }
}

async function tick(val){
  if(!state.token){ alert('Bitte Token eintragen'); return; }
  ensureRoom();
  const me=state.player.toLowerCase();
  const rec=state.cache[state.room][state.today]||{anu:false,domik:false};
  rec[me]=val;
  state.cache[state.room][state.today]=rec;
  render();
  await saveData();
}

$('saveCfg').onclick=()=>{
  state.player=$('player').value; state.room=$('room').value;
  state.owner=$('ghOwner').value; state.repo=$('ghRepo').value;
  state.branch=$('ghBranch').value; state.path=$('ghPath').value;
  state.token=$('ghToken').value;
  for(const k in state) if(typeof state[k]==='string') localStorage.setItem(k,state[k]);
  loadData();
};
$('btnDone').onclick=()=>tick(true);
$('btnUndo').onclick=()=>tick(false);
loadData();
</script>
</body>
</html>
